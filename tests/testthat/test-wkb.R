
test_that("s2latlng can be imported from wkb", {
  # SRID=4326;POINT (-64 45)
  wkb_point <- list(as.raw(c(0x01, 0x01, 0x00, 0x00, 0x20, 0xe6, 0x10, 0x00,
                             0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x50, 0xc0, 0x00, 0x00,
                             0x00, 0x00, 0x00, 0x80, 0x46, 0x40)))
  class(wkb_point) <- "wk_wkb"

  expect_identical(
    as.data.frame(s2latlng(wkb_point)),
    data.frame(lat = 45, lng = -64)
  )
})

test_that("s2latlng can be exported to wkb", {
  # SRID=4326;POINT (-64 45)
  wkb_point <- list(as.raw(c(0x01, 0x01, 0x00, 0x00, 0x00,
                             0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x50, 0xc0, 
							 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x46, 0x40)))
  class(wkb_point) <- "wk_wkb"

  expect_identical(as_wkb(s2latlng(45, -64), endian = 1), wkb_point)
  expect_identical(as_wkb(s2latlng(double(), double())[NA]), structure(list(NULL), class = "wk_wkb"))
})

test_that("s2polyline can be imported from wkb", {
  # SRID=4326;LINESTRING (-64 45, 8 52)
  wkb_polyline <- list(as.raw(c(0x01, 0x02, 0x00, 0x00, 0x00, 
                                0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x50, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x46, 0x40, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x40, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x4a, 0x40)))
  class(wkb_polyline) <- "wk_wkb"

  expect_equal(
    as.data.frame(s2polyline(wkb_polyline)),
    data.frame(lat = c(45, 52), lng = c(-64, 8))
  )
})

test_that("s2polyline can be exported to wkb", {
  # SRID=4326;LINESTRING (-64 45, 8 52)
  wkb_polyline <- list(as.raw(c(0x01, 0x02, 0x00, 0x00, 0x00, 
                                0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x50, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x46, 0x40, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x40, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x4a, 0x40)))
  class(wkb_polyline) <- "wk_wkb"

  # comes back slightly rounded...hard to test for this
  wkb <- as_wkb(s2polyline(s2latlng(c(45, 52), c(-64, 8))), endian = 1)
  expect_is(wkb, "wk_wkb")
  expect_equal(as.data.frame(s2polyline(wkb)), as.data.frame(s2polyline(wkb_polyline)))
  expect_identical(as_wkb(new_s2xptr(list(NULL), "s2polyline")), structure(list(NULL), class = "wk_wkb"))
})

test_that("s2polygon can be imported from wkb", {
  # SRID=4326;POLYGON ((35 10, 45 45, 15 40, 10 20, 35 10), (20 30, 35 35, 30 20, 20 30))
  wkb_polygon <- list(as.raw(c(0x01, 0x03, 0x00, 0x00, 0x00, 
                               0x02, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0x00, 0x00, 0x80, 0x41, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0x24, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x46, 0x40,
                               0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x46, 0x40, 0x00, 0x00, 0x00,
                               0x00, 0x00, 0x00, 0x2e, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x44, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40, 0x00,
                               0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0x80, 0x41, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24,
                               0x40, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x34, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x40, 0x00,
                               0x00, 0x00, 0x00, 0x00, 0x80, 0x41, 0x40, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0x80, 0x41, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e,
                               0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40, 0x00, 0x00,
                               0x00, 0x00, 0x00, 0x00, 0x34, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0x3e, 0x40)))
  class(wkb_polygon) <- "wk_wkb"

  dfs <- lapply(s2polyline(s2polygon(wkb_polygon, oriented = TRUE, check = FALSE)), as.data.frame)
  expect_equal(dfs[[1]], data.frame(lat = c(10, 45, 40, 20), lng = c(35, 45, 15, 10)))
  # ring directions seem to all be counter clockwise when oriented = TRUE...
  expect_equal(dfs[[2]], data.frame(lat = c(20, 35, 30), lng = c(30, 35, 20)))

  # this should work with check as true and false
  expect_identical(
    lapply(s2polyline(s2polygon(wkb_polygon, oriented = TRUE, check = TRUE)), as.data.frame),
    lapply(s2polyline(s2polygon(wkb_polygon, oriented = TRUE, check = FALSE)), as.data.frame)
  )
})

test_that("s2polygon can be exported to wkb", {
  # SRID=4326;POLYGON ((35 10, 45 45, 15 40, 10 20, 35 10), (20 30, 35 35, 30 20, 20 30))
  wkb_polygon <- list(as.raw(c(0x01, 0x03, 0x00, 0x00, 0x00, 
                               0x02, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0x00, 0x00, 0x80, 0x41, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0x24, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x46, 0x40,
                               0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x46, 0x40, 0x00, 0x00, 0x00,
                               0x00, 0x00, 0x00, 0x2e, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x44, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40, 0x00,
                               0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0x80, 0x41, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24,
                               0x40, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x34, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x40, 0x00,
                               0x00, 0x00, 0x00, 0x00, 0x80, 0x41, 0x40, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0x80, 0x41, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e,
                               0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40, 0x00, 0x00,
                               0x00, 0x00, 0x00, 0x00, 0x34, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0x3e, 0x40)))
  class(wkb_polygon) <- "wk_wkb"

  loop_one <- s2latlng(c(10, 45, 40, 20), c(35, 45, 15, 10))
  loop_two <- s2latlng(c(30, 35, 20), c(20, 35, 30))

  polygon <- s2polygon(c(s2polyline(loop_one), s2polyline(loop_two)), oriented = TRUE)

  # comes back slightly rounded...hard to test for this
  wkb <- as_wkb(polygon, endian = 1)
  expect_is(wkb, "wk_wkb")
# FIXME:?
#  expect_equal(
#    lapply(s2polyline(s2polygon(wkb, oriented = TRUE)), as.data.frame),
#    lapply(s2polyline(s2polygon(wkb_polygon, oriented = TRUE)), as.data.frame)
#  )
  expect_identical(as_wkb(new_s2xptr(list(NULL), "s2polygon")), structure(list(NULL), class = "wk_wkb"))
})
